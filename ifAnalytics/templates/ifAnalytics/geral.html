{% extends 'ifAnalytics/base.html' %}

{% block content %}
<script> //GRÁFICO 1: FORMA DE INGRESSO - Primeira versão (original)

  let data_forma_ingresso

  function renderChartFormaIngresso(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_forma_ingresso" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_forma_ingresso/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         data_forma_ingresso = data_from_view
         google.charts.setOnLoadCallback(function() {drawChart_forma_ingresso(data_forma_ingresso);});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }

  // Populando o gráfico com dados
  function drawChart_forma_ingresso(data_forma_ingresso) {
     let data = new google.visualization.DataTable();
     data.addColumn('string', 'Forma de Ingresso');
     data.addColumn('number', 'Alunos');

     for (let i = 0; i < data_forma_ingresso.length; i++) {
            data.addRows([data_forma_ingresso[i]]);
     }

     let options = {
            title: 'Forma de Ingresso',
            backgroundColor: '#E1F0DB',
            chartArea: {left: 10, height: 250, width: 600},
            legend: {textStyle: {fontSize: 10}},
            titleTextStyle: {fontSize:14, bold: true, color:'grey'},
            sliceVisibilityThreshold: 0,
     };

     let chart = new google.visualization.PieChart(document.getElementById('pieChart_forma_ingresso'));


  /////////////////////////////////////////////////////////////// testes de interatividade!!!
              function selectHandler() {
                  var selectedItem = chart.getSelection()[0];
                  if (selectedItem) {
                    var value = data.getValue(selectedItem.row, 0);
                      //var value = data.getValue(selectedItem.row, selectedItem.column); //como estava no exemplo
                      alert('The user selected ' + value);

                      // o que eu quero aqui é que passe pra uma view o parametro da consulta que será executada
                      //para que o resultado dessa consulta preencha a tabela

                      //mais ou menos assim:
                                                 //  $.ajax({
                                                 //       url: '/consulta_forma_ingresso_detalhes/',
                                                 //       data: {
                                                 //            'parametro' : value
                                                 //        },
                                                 // })
                      //criar a view consulta_forma_ingresso_detalhes na views.py, com as rotas e tudo mais
                     }
              }

                // Listen for the 'select' event, and call my function selectHandler() when
                // the user selects something on the chart.
                google.visualization.events.addListener(chart, 'select', selectHandler);
  ///////////////////////////////////////////////////////////////

     chart.draw(data, options);
  }
</script>


<script> //GRÁFICO 2: STATUS DISCENTE - Segunda versão, usando parametros para chamar a função que desenha os gráficos

  let dados
  let tipo_coluna1
  let tipo_coluna2

  function renderChartStatusDiscente(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_status_discente" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_status_discente/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         dados = data_from_view
         tipo_coluna1 = 'string'
         tipo_coluna2 = 'number'
         coluna_1 = 'Status dos Discentes'
         coluna_2 = 'Quantidade de Alunos'
         titulo_grafico = 'Status dos Discentes'
         google.charts.setOnLoadCallback(function() {drawGeralPizza(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, 'pieChart_status_discente');});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }
</script>


<script> //GRÁFICO 3: TOTAL MATRICULAS (EM COLUNAS)

   function renderChartTotalMatriculas(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_total_matriculas" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_total_matriculas/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         dados = data_from_view
         tipo_coluna1 = 'number'
         tipo_coluna2 = 'number'
         titulo_grafico = 'Quantidade de disciplinas pela respectiva quantidade de alunos' //'Quantidade de alunos matriculados em um total de X disciplinas'
         titulo_hAxis = 'Disciplinas'
         titulo_vAxis = 'Alunos'
         google.charts.setOnLoadCallback(function() {drawGeralColuna(dados, tipo_coluna1, 'Disciplinas', tipo_coluna2, 'Quantidade_Alunos', titulo_grafico, titulo_hAxis, titulo_vAxis, 'columnChart_total_matriculas');});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }
</script>

<script> //GRÁFICO 4 e 5: CONCLUÍNTES E NÃO CONCLUÍNTES (EM COLUNAS)

   function renderChartConcluintes(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_concluintes" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_concluintes/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         dados = data_from_view
         let dadosNovoArray = formataRetorno(dados, "Alunos que Passaram do Prazo de Conclusao", "Alunos Formandos");
         tipo_coluna1 = 'string'
         tipo_coluna2 = 'number'
         titulo_grafico = 'Não Concluíntes e Formandos'
         titulo_hAxis = 'Não Concluíntes e Formandos'
         titulo_vAxis = ''
         google.charts.setOnLoadCallback(function() {drawGeralColuna(dadosNovoArray, tipo_coluna1, 'Situação', tipo_coluna2, 'Quantidade', titulo_grafico, titulo_hAxis, titulo_vAxis, 'columnChart_concluintes');});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }
</script>

<script> //GRÁFICO 6: TAMANHO DAS TURMAS (EM COLUNAS)

   function renderChartTamanhoTurmas(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_tamanho_turmas" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_tamanho_turmas/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         dados = data_from_view
         tipo_coluna1 = 'string'
         tipo_coluna2 = 'number'
         titulo_grafico = 'Tamanho da(s) Turma(s)'
         titulo_hAxis = 'Disciplinas'
         titulo_vAxis = 'Alunos Matriculados'
         google.charts.setOnLoadCallback(function() {drawGeralColuna(dados, tipo_coluna1, 'Disciplina', tipo_coluna2, 'Alunos_matriculados', titulo_grafico, titulo_hAxis, titulo_vAxis, 'columnChart_tamanho_turmas');});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }
</script>


<script> //GRÁFICO 7: DISCENTES EVADIDOS
  function renderChartDiscentesEvadidos(querySelector, campusId, ano, semestre, cursoId, turmaId){
    //pegando os dados da view "get_data_discentes_evadidos" para popular o gráfico
    $.ajax({
        method: "GET",
        url: '/get_data_discentes_evadidos/', 
        data: {
          'campus_id' : campusId,
          'curso_id' : cursoId,
          'ano' : ano,
          'semestre' : semestre,
          'turma_id': turmaId,
          'querySelector' : querySelector
       },
       success: function(data_from_view){
         dados = data_from_view
         tipo_coluna1 = 'string'
         tipo_coluna2 = 'number'
         titulo_grafico = 'Discentes Evadidos'
         titulo_hAxis = 'Disciplinas'
         titulo_vAxis = 'Alunos Evadidos'
         google.charts.setOnLoadCallback(function() {drawGeralColuna(dados, tipo_coluna1, 'Discentes Evadidos', tipo_coluna2, 'Alunos_evadidos', titulo_grafico, titulo_hAxis, titulo_vAxis, 'columnChart_discentes_evadidos');});
       },
       error: function(error_data){
          console.log("error")
          console.log(error_data)
       }
    })
  }
</script>


<script> //POPULANDO OS GRÁFICOS!
  // Funções que populam os gráficos com dados

  function drawGeralPizza(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, id_div){
      data = new google.visualization.DataTable();
      data.addColumn(tipo_coluna1, coluna_1);
      data.addColumn(tipo_coluna2, coluna_2);

     for (let i = 0; i < dados.length; i++) {
            data.addRows([dados[i]]);
     }

     let options = {
            title: titulo_grafico,
            backgroundColor: '#E1F0DB',
            chartArea: {left: 10, height: 250, width: 600},
            legend: {textStyle: {fontSize: 10}},
            titleTextStyle: {fontSize:14, bold: true, color:'grey'},
            sliceVisibilityThreshold: 0,
     };

     let chart = new google.visualization.PieChart(document.getElementById(id_div));

     chart.draw(data, options);
  }


  function drawGeralColuna(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, titulo_hAxis, titulo_vAxis, id_div) {
     data = new google.visualization.DataTable();
     data.addColumn(tipo_coluna1, coluna_1);
     data.addColumn(tipo_coluna2, coluna_2);

     for (let i = 0; i < dados.length; i++) {
            data.addRows([dados[i]]);
     }

     let options = {
            title: titulo_grafico,
            hAxis: {
              title: titulo_hAxis
            },
            vAxis: {
              title: titulo_vAxis
            },
            backgroundColor: '#E1F0DB',
            chartArea: {left: 10, height: 250, width: 600},
            legend: {textStyle: {fontSize: 10}},
            titleTextStyle: {fontSize:14, bold: true, color:'grey'},
     };

     let chart = new google.visualization.ColumnChart(document.getElementById(id_div));

     chart.draw(data, options);
  }
</script>

<script> //FUNÇÕES GERIAS

   function formataRetorno(dados, label_linha_1, label_linha_2){
        //pega o retorno da consulta (que vem em uma linha) e quebra em duas linhas, adicionando o label da linha para poder gerar o grafico
        let dadosNovo = dados[0].toString().split(",");
        let posicao1 = [label_linha_1,parseInt(dadosNovo[0], 10)];
        let posicao2 = [label_linha_2,parseInt(dadosNovo[1], 10)];
        let dadosNovoArray= [posicao1, posicao2];
        return dadosNovoArray;
  }
</script>

<div id="dashboards"> <!-- ÁREA DE PLOTAGEM DOS GRÁFICOS -->
	<div id="pieChart_forma_ingresso" class="grafico alinha_grafico_esquerda"></div>
  <div id="pieChart_status_discente" class="grafico alinha_grafico_direita"></div>
  <div id="columnChart_total_matriculas" class="grafico alinha_grafico_esquerda"></div>
  <div id="columnChart_concluintes" class="grafico alinha_grafico_direita"></div>
  <div id="columnChart_tamanho_turmas" class="grafico alinha_grafico_esquerda"></div>
  <div id="columnChart_discentes_evadidos" class="grafico alinha_grafico_direita"></div>
</div>
{% endblock %}