{% extends 'ifAnalytics/base.html' %}

{% block content %}

<script>

       let dados

       function renderChartNotasParciais(unidade, querySelector, campusId, ano, semestre, cursoId, turmaId){
         //pegando os dados da view "get_data_notas_parciais" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_notas_parciais/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'unidade' : unidade,
                     'querySelector' : querySelector
                     },
              success: function(data_from_view){
                     dados = data_from_view

                     //pega o retorno da consulta (que vem em uma linha) e quebra em duas linhas, adicionando o label da linha para poder gerar o grafico
                     //exemplo original, nos demais foi utilizada a função formataRetorno();
                     let dadosNovo = dados[0].toString().split(",");
                     let posicao1 = ["Acima de 7",parseInt(dadosNovo[0], 10)];
                     let posicao2 = ["Abaixo de 7",parseInt(dadosNovo[1], 10)];
                     let dadosNovoArray= [posicao1, posicao2];

                     if (unidade == 1) {
                       google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, 'Situação', 'Alunos', 'Notas Parciais Unidade 1', 'pieChart_notas_parciais_unidade1');});
                     } else {
                       google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, 'Situação', 'Alunos', 'Notas Parciais Unidade 2', 'pieChart_notas_parciais_unidade2');});
                     }
              },
              error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       function renderChartMediasFinais(querySelector, campusId, ano, semestre, cursoId, turmaId){
              //pegando os dados da view "get_data_medias_finais" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_medias_finais/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'querySelector' : querySelector
              },
              success: function(data_from_view){
                     dados = data_from_view
                     let dadosNovoArray = formataRetorno(dados, "Acima de 5", "Abaixo de 5");
                     google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, 'Situação', 'Alunos', 'Médias Finais', 'pieChart_medias_finais');});
              },
                     error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       //Funções que desenham todos os gráficos
       function drawGeralPizza(dados, coluna_1, coluna_2, titulo, id_div){
              data = new google.visualization.DataTable();
              data.addColumn('string', coluna_1);
              data.addColumn('number', coluna_2);

              for (let i = 0; i < dados.length; i++) {
                   data.addRows([dados[i]]);
              }

              let options = {
                   title: titulo,
                   backgroundColor: '#E1F0DB',
                   chartArea: {left: 10, height: 250, width: 600},
                   legend: {textStyle: {fontSize: 10}},
                   titleTextStyle: {fontSize:14, bold: true, color:'grey'},
                   sliceVisibilityThreshold: 0,
              };

              let chart = new google.visualization.PieChart(document.getElementById(id_div));

              chart.draw(data, options);
       }

       function drawGeralColuna(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, titulo_hAxis, titulo_vAxis, id_div) {
              data = new google.visualization.DataTable();
              data.addColumn(tipo_coluna1, coluna_1);
              data.addColumn(tipo_coluna2, coluna_2);

              for (let i = 0; i < dados.length; i++) {
                     data.addRows([dados[i]]);
              }

              let options = {
                   title: titulo_grafico,
                   hAxis: {
                     title: titulo_hAxis
                   },
                   vAxis: {
                     title: titulo_vAxis
                   },
                   backgroundColor: '#E1F0DB',
                   chartArea: {left: 10, height: 250, width: 600},
                   legend: {textStyle: {fontSize: 10}},
                   titleTextStyle: {fontSize:14, bold: true, color:'grey'},
              };

              let chart = new google.visualization.ColumnChart(document.getElementById(id_div));

              chart.draw(data, options);
       }

       function formataRetorno(dados, label_linha_1, label_linha_2){
              //pega o retorno da consulta (que vem em uma linha) e quebra em duas linhas, adicionando o label da linha para poder gerar o grafico
              let dadosNovo = dados[0].toString().split(",");
              let posicao1 = [label_linha_1,parseInt(dadosNovo[0], 10)];
              let posicao2 = [label_linha_2,parseInt(dadosNovo[1], 10)];
              let dadosNovoArray= [posicao1, posicao2];
              return dadosNovoArray;
       }
</script>

<div id="dashboards"> <!-- ÁREA DE PLOTAGEM DOS GRÁFICOS -->
  <div id="pieChart_notas_parciais_unidade1" class="grafico alinha_grafico_esquerda"></div>
  <div id="pieChart_notas_parciais_unidade2" class="grafico alinha_grafico_direita"></div>
  <div id="pieChart_medias_finais" class="grafico alinha_grafico_esquerda"></div>
</div>
{% endblock %}