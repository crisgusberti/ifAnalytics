{% extends 'ifAnalytics/base.html' %}

{% block content %}

<script>

       let dados

       function renderChartNotasParciais(unidade, querySelector, campusId, ano, semestre, cursoId, turmaId){
         //pegando os dados da view "get_data_notas_parciais" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_notas_parciais/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'unidade' : unidade,
                     'querySelector' : querySelector
                     },
              success: function(data_from_view){
                     dados = data_from_view
                     label_linha_1 = "ACIMA DE 7"
                     label_linha_2 = "ABAIXO DE 7"
                     let dadosNovoArray = formataRetorno(dados, label_linha_1, label_linha_2);
                     tipo_coluna1 = 'string'
                     tipo_coluna2 = 'number'
                     coluna_1 = 'Situação'
                     coluna_2 = 'Quantidade de Alunos'
                     
                     if (unidade == 1) {
                       google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, 'Notas Parciais Unidade 1', 'pieChart_notas_parciais_unidade1');});
                     } else {
                       google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray,  tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, 'Notas Parciais Unidade 2', 'pieChart_notas_parciais_unidade2');});
                     }
              },
                    error: function(error_data){
                    console.log("error")
                    console.log(error_data)
              }
              })
       }

       function renderChartMediasFinais(querySelector, campusId, ano, semestre, cursoId, turmaId){
              //pegando os dados da view "get_data_medias_finais" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_medias_finais/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'querySelector' : querySelector
              },
              success: function(data_from_view){
                     dados = data_from_view
                     label_linha_1 = "ACIMA DE 5"
                     label_linha_2 = "ABAIXO DE 5"
                     let dadosNovoArray = formataRetorno(dados, label_linha_1, label_linha_2);
                     tipo_coluna1 = 'string'
                     tipo_coluna2 = 'number'
                     coluna_1 = 'Situação'
                     coluna_2 = 'Quantidade de Alunos'
                     titulo_grafico = 'Médias Finais'
                     google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, 'pieChart_medias_finais');});
              },
                     error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       function renderChartDiscenteExame(querySelector, campusId, ano, semestre, cursoId, turmaId){
              //pegando os dados da view "get_data_discentes_exame" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_discentes_exame/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'querySelector' : querySelector
              },
              success: function(data_from_view){
                     dados = data_from_view
                     label_linha_1 = "DISCENTES QUE NÃO ESTÃO EM EXAME"
                     label_linha_2 = "DISCENTES EM EXAME"
                     let dadosNovoArray = formataRetorno(dados, label_linha_1, label_linha_2);
                     tipo_coluna1 = 'string'
                     tipo_coluna2 = 'number'
                     coluna_1 = 'Discentes que não estão em exame'
                     coluna_2 = 'Discentes em exame'
                     titulo_grafico = 'Discentes em Exame'
                     google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, 'pieChart_discentes_exame');});
              },
                     error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       function renderChartAprovadosReprovados(querySelector, campusId, ano, semestre, cursoId, turmaId){
              //pegando os dados da view "get_data_aprovados_reprovados" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_aprovados_reprovados/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'querySelector' : querySelector
              },
              success: function(data_from_view){
                     dados = data_from_view
                     label_linha_1 = "DISCENTES APROVADOS"
                     label_linha_2 = "DISCENTES REPROVADOS"
                     let dadosNovoArray = formataRetorno(dados, label_linha_1, label_linha_2);
                     tipo_coluna1 = 'string'
                     tipo_coluna2 = 'number'
                     coluna_1 = 'Discentes Aprovados'
                     coluna_2 = 'Discentes Reprovados'
                     titulo_grafico = 'Aprovados e Reprovados'
                     google.charts.setOnLoadCallback(function() {drawGeralPizza(dadosNovoArray, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, 'pieChart_aprovados_reprovados');});
              },
                     error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       function renderChartStatusDisciplinas(querySelector, campusId, ano, semestre, cursoId, turmaId){
              //pegando os dados da view "get_data_status_disciplina" para popular o gráfico
              $.ajax({
                     method: "GET",
                     url: '/get_data_status_disciplina/', 
                     data: {
                     'campus_id' : campusId,
                     'curso_id' : cursoId,
                     'ano' : ano,
                     'semestre' : semestre,
                     'turma_id': turmaId,
                     'querySelector' : querySelector
              },
              success: function(data_from_view){
                     dados = data_from_view
                     tipo_coluna1 = 'string'
                     tipo_coluna2 = 'number'
                     coluna_1 = 'Status Disciplina'
                     coluna_2 = 'Quantidade Alunos'
                     titulo_grafico = 'Quantidade por Status nas Disciplinas'
                     google.charts.setOnLoadCallback(function() {drawGeralPizza(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, 'pieChart_status_disciplina');});
              },
                     error: function(error_data){
                     console.log("error")
                     console.log(error_data)
              }
              })
       }

       //Funções que desenham todos os gráficos
       function drawGeralPizza(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, id_div){
              data = new google.visualization.DataTable();
              data.addColumn(tipo_coluna1, coluna_1);
              data.addColumn(tipo_coluna2, coluna_2);

              for (let i = 0; i < dados.length; i++) {
                   data.addRows([dados[i]]);
              }

              let options = {
                   title: titulo_grafico,
                   backgroundColor: '#E1F0DB',
                   chartArea: {left: 10, height: 250, width: 600},
                   legend: {textStyle: {fontSize: 10}},
                   titleTextStyle: {fontSize:14, bold: true, color:'grey'},
                   sliceVisibilityThreshold: 0,
              };

              let chart = new google.visualization.PieChart(document.getElementById(id_div));

              chart.draw(data, options);
       }

       function drawGeralColuna(dados, tipo_coluna1, coluna_1, tipo_coluna2, coluna_2, titulo_grafico, titulo_hAxis, titulo_vAxis, id_div) {
              data = new google.visualization.DataTable();
              data.addColumn(tipo_coluna1, coluna_1);
              data.addColumn(tipo_coluna2, coluna_2);

              for (let i = 0; i < dados.length; i++) {
                     data.addRows([dados[i]]);
              }

              let options = {
                   title: titulo_grafico,
                   hAxis: {
                     title: titulo_hAxis
                   },
                   vAxis: {
                     title: titulo_vAxis
                   },
                   backgroundColor: '#E1F0DB',
                   chartArea: {left: 10, height: 250, width: 600},
                   legend: {textStyle: {fontSize: 10}},
                   titleTextStyle: {fontSize:14, bold: true, color:'grey'},
              };

              let chart = new google.visualization.ColumnChart(document.getElementById(id_div));

              chart.draw(data, options);
       }

       function formataRetorno(dados, label_linha_1, label_linha_2){
              //pega o retorno da consulta (que vem em uma linha) e quebra em duas linhas, adicionando o label da linha para poder gerar o grafico

              //dependendo do que foi selecionados nos combos, a consulta pode retornar vazia
              //esse if/else faz uma verificação para evitar erros no console.
              if(dados == null || dados.length == 0){ //Se o retorno da consulta for vazio 
                let posicao1 = [label_linha_1,0];     //o vetor é preenchido com label da linha e valor 0
                let posicao2 = [label_linha_2,0];    
                let dadosNovoArray= [posicao1, posicao2];
                return dadosNovoArray;               
              }else{                    //senão faz o tratamento normal dos dados que retornaram da consulta
                let dadosNovo = dados[0].toString().split(",");
                let posicao1 = [label_linha_1,parseInt(dadosNovo[0], 10)];
                let posicao2 = [label_linha_2,parseInt(dadosNovo[1], 10)];
                let dadosNovoArray= [posicao1, posicao2];
                return dadosNovoArray;
              }
       }
</script>

<div id="dashboards"> <!-- ÁREA DE PLOTAGEM DOS GRÁFICOS -->
  <div id="pieChart_notas_parciais_unidade1" class="grafico alinha_grafico_esquerda"></div>
  <div id="pieChart_notas_parciais_unidade2" class="grafico alinha_grafico_direita"></div>
  <div id="pieChart_medias_finais" class="grafico alinha_grafico_esquerda"></div>
  <div id="pieChart_discentes_exame" class="grafico alinha_grafico_direita"></div>
  <div id="pieChart_aprovados_reprovados" class="grafico alinha_grafico_esquerda"></div>
  <div id="pieChart_status_disciplina" class="grafico alinha_grafico_direita"></div>
</div>
{% endblock %}